<!DOCTYPE html>
<html>
	<head>
		<title></title>
		<script src="three.js"></script>
		<script src="jquery.min.js"></script>
		<link rel="stylesheet" type="text/css" href="bootstrap.min.css">
		<script type="text/javascript">
			var camera;
			var scene;
			var objRend;
			var render;
			var curGru=5;
			var listElm=[];
			var listGru=[];
			var listPiv={};
			
			function drawXYZ(x,y,z,w,c){
				var rvec=10;
				var mat1=new THREE.LineBasicMaterial({color:"rgb(255,0,0)"}); //x
				var mat2=new THREE.LineBasicMaterial({color:"rgb(0,0,255)"}); //y
				var mat3=new THREE.LineBasicMaterial({color:"rgb(0,255,0)"}); //z
				var geo1=new THREE.Geometry();
				var geo2=new THREE.Geometry();
				var geo3=new THREE.Geometry();
				geo1.vertices.push(new THREE.Vector3(x,y,z), new THREE.Vector3(x+rvec,y,z));
				geo2.vertices.push(new THREE.Vector3(x,y,z), new THREE.Vector3(x,y+rvec,z));
				geo3.vertices.push(new THREE.Vector3(x,y,z), new THREE.Vector3(x,y,z+rvec));
				var lin1=new THREE.Line(geo1,mat1);
				var lin2=new THREE.Line(geo2,mat2);
				var lin3=new THREE.Line(geo3,mat3);
				scene.add(lin1);
				scene.add(lin2);
				scene.add(lin3);
			}
			function getRandomColor(){
				var n1=Math.round(Math.random()*255);
				var n2=Math.round(Math.random()*255);
				var n3=Math.round(Math.random()*255);
				return "rgb("+n1+","+n2+","+n3+")";
			}
			function addCylinder(x,y,z,rx,ry,rz,w,h,d,son,father){
				//objeto base
				var geom_base = new THREE.BoxGeometry(w,h,d);
				var mate_base = new THREE.MeshBasicMaterial( {color: getRandomColor()} );
				var cubo_base = new THREE.Mesh( geom_base, mate_base )
				cubo_base.position.x = x;
				cubo_base.position.y = y;
				cubo_base.position.z = z;
				cubo_base.rotation.x = rx;
				cubo_base.rotation.y = ry;
				cubo_base.rotation.z = rz;
				//bordes de la geometria
				/*
				var edges = new THREE.EdgesGeometry( geom_base );
				var line  = new THREE.LineSegments(edges, new THREE.LineBasicMaterial( { color: "rgb(255,255,0)" } ));
				line.position.x = x;
				line.position.y = y;
				line.position.z = z;
				line.rotation.x = rx;
				line.rotation.y = ry;
				line.rotation.z = rz;*/
				//agregando al render
				//scene.add(line);
				if( listElm.length==0 )
					scene.add(cubo_base);
				listElm.push({
					son:son,
					father:father,
					data:cubo_base,
					/*
					rota_z:function(d){
						this.data.rotation.z+=d;
						this.line.rotation.z+=d;
						//haciendo rotacion de hijos
						var idSon=this.son;
						var tmpOb;
						while( idSon>0 ){
							//console.log(idSon);
							tmpOb=listElm[idSon];
							idSon=tmpOb.son;
						}
					},
					//x' = xcos(alpha) - ysen(alpha)
					//y' = xsen(alpha) + ycos(alpha)
					rota_giro:function(d){
						this.data.rotateOnAxis(new THREE.Vector3( 0, 1, 0 ), d);
						var tmpx=this.data.position.x;
						var tmpz=this.data.position.z-10;
						//this.data.position.x=tmpx*Math.cos(d)-tmpy*Math.sin(d);
						//this.data.position.y=tmpx*Math.sin(d)-tmpx*Math.cos(d);
						this.data.position.x=tmpx*Math.cos(d)-tmpz*Math.sin(d);
						this.data.position.z=tmpx*Math.sin(d)+tmpz*Math.cos(d)+10;
					}*/
				});
			}
			function roundn(n,d){
				var p=Math.pow(10,d);
				return Math.round(n*p)/p;
			}

			var pivot;
			$(window).load(function(){
				//creando objeto base
				objRend =document.getElementById("canvas_render");
				scene   =new THREE.Scene();
				camera  =new THREE.PerspectiveCamera(90, objRend.width/objRend.height, 0.1, 1000);
				render  =new THREE.WebGLRenderer({canvas:objRend});
				//ajustando la posicion de la camara
				camera.position.z = 15;
				camera.position.x = 15;
				camera.position.y = 15;
				camera.lookAt(0,0,5);
				camera.rotation.z = 2.62;


				/*creando elementos base del brazo*/
				addCylinder(0,0,2,0,0,0,1,1,4,0,0);
				addCylinder(0,0,6,0,0,0,1,1,4,0,0);
				addCylinder(0,0,11,0,0,0,1,1,6,0,0);
				addCylinder(0,0,14.5,0,0,0,1,1,1,0,0);
				addCylinder(0,0,16,0,0,0,1,1,2,0,0);
				addCylinder(0,0,17.5,0,0,0,1,1,1,0,0);
				addCylinder(0,0,18.5,0,0,0,1,1,1,0,0);
				
				var grup5=new THREE.Group();
				var grup4=new THREE.Group();
				var grup3=new THREE.Group();
				var grup2=new THREE.Group();
				var grup1=new THREE.Group();
				var grup0=new THREE.Group();
				scene.add(grup5);
				scene.add(grup4);
				scene.add(grup3);
				scene.add(grup2);
				scene.add(grup1);
				scene.add(grup0);


				




				grup0.add(listElm[6].data);
				listGru.push({tip_rot:0,data:grup0});

				grup1.add(listElm[5].data);
				grup1.add(grup0);
				listGru.push({tip_rot:1,data:grup1});

				grup2.add(listElm[4].data);
				grup2.add(grup1);
				listGru.push({tip_rot:0,data:grup2});

				grup3.add(listElm[3].data);
				grup3.add(grup2);
				listGru.push({tip_rot:1,data:grup3});

				grup4.add(listElm[2].data);
				grup4.add(grup3);
				listGru.push({tip_rot:1,data:grup4});

				grup5.add(listElm[1].data);
				grup5.add(grup4);
				listGru.push({tip_rot:0,data:grup5});


				//prueba pivot 3
				//pivotPoint = new THREE.Object3D();
       			//pivotPoint.position.set(0,0,5);
       			//pivotPoint.add(grup3);
       			

       			//creando pivotes
       			pivot4 = new THREE.Group();
				scene.add( pivot4 );
				pivot4.add( grup4 );
				pivot4.position.set(0,0,8);
				grup4.position.set(0,0,-8);
				listPiv[4]=pivot4;
				grup5.add(pivot4);


				pivot3 = new THREE.Group();
				scene.add( pivot3 );
				pivot3.add( grup3 );
				pivot3.position.set(0,0,14);
				grup3.position.set(0,0,-14);
				listPiv[3]=pivot3;
				grup4.add(pivot3);


				pivot1 = new THREE.Group();
				scene.add( pivot1 );
				pivot1.add( grup1 );
				pivot1.position.set(0,0,17);
				grup1.position.set(0,0,-17);
				listPiv[1]=pivot1;
				grup2.add(pivot1);
       			
				






				drawXYZ(0,0,0);
				
				var animate = function () {
					requestAnimationFrame( animate );
					render.render( scene, camera );
					scene.updateWorldMatrix();
				};
				animate();

				var rad=0;
				$(document).on("keydown", function(e){

					if(e.keyCode==37){
						if( listGru[curGru].tip_rot==0 )
							listGru[curGru].data.rotation.z+=0.1;
						else{
							//listGru[curGru].data.rotation.x+=0.1;
							//listGru[curGru].data.rotation.x+=0.1;
							listPiv[curGru].rotation.x+=0.1;
						}
					}
					else if(e.keyCode==39){
						if( listGru[curGru].tip_rot==0 )
							listGru[curGru].data.rotation.z-=0.1;
						else{
							listPiv[curGru].rotation.x-=0.1;
							//listGru[curGru].data.rotation.x-=0.1;
							//listGru[curGru].data.rotation.x-=0.1;
						}
					}

					/*
					//evento de rotar en eje z
					if(e.keyCode==37){
						listElm[curElm].rota_z(-0.1);
					}
					else if(e.keyCode==39){
						listElm[curElm].rota_z(+0.1);
					}

					//zoom de prueba
					else if(e.keyCode==97){
						camera.fov+=0.5;
						camera.updateProjectionMatrix();
					}
					else if(e.keyCode==98){
						camera.fov-=0.5;
						camera.updateProjectionMatrix();
					}

					//prueba de eje
					curElm=2;
					if(e.keyCode==38){
						listElm[curElm].rota_giro(-0.1);
					}
					else if(e.keyCode==40){
						listElm[curElm].rota_giro(+0.1);
					}
					*/



					/*
					if(e.keyCode==37)
						cylinder.rotation.x-=0.1;
					else if(e.keyCode==39)
						cylinder.rotation.x+=0.1;
					else if(e.keyCode==38)
						camera.rotation.y+=0.1;
					else if(e.keyCode==40)
						camera.rotation.y-=0.1;
					else if(e.keyCode==81)
						camera.rotation.z-=0.1;
					else if(e.keyCode==87)
						camera.rotation.z+=0.1;
					*/
				});

				$(document).on("click", "#listGru", function(){
					curGru=$(this).val();
				});

				$(document).on("click", ".lstBtn", function(){
					$(".lstBtn").removeClass("curBtn");
					$(".lstBtn").removeClass("btn-primary");
					$(this).addClass("curBtn");
					$(this).addClass("btn-primary");
					curGru=$(this).attr("inf");
				});

				$(document).on("click", "#btnAdd", function(){
					var tmp=listElm[6].data.localToWorld( new THREE.Vector3(0,0,0) );
					var x=roundn(tmp.x,2);
					var y=roundn(tmp.y,2);
					var z=roundn(tmp.z,2);
					$("#txtCod").val( $("#txtCod").val()+"MOVETO("+x+","+y+","+z+")\n" );
				});

				/*
				var objRend=document.getElementById("canvas_render");
				var scene = new THREE.Scene();
				var camera = new THREE.PerspectiveCamera( 75, objRend.width/objRend.height, 0.1, 1000 );
				var renderer = new THREE.WebGLRenderer({canvas:objRend});
				var geometry = new THREE.BoxGeometry( 1, 1, 1 );
				var material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
				var cube = new THREE.Mesh( geometry, material );
				scene.add( cube );
				camera.position.z = 5;
				
				*/

			});
		</script>
	</head>
	<body>
		<div style="height: 600px;" class="col-sm-6">
			<textarea style="height: 100%; resize: none;" id="txtCod" placeholder="Codigo" class="form-control"></textarea>
		</div>
		<div style="height: 600px;" class="col-sm-6 text-center">
			<canvas width="500" height="600" id="canvas_render"></canvas>
		</div>
		<div style="margin-top: 10px;" class="col-sm-12">
			<button class="btn lstBtn btn-sm" inf="0">Bloque 0</button>
			<button class="btn lstBtn btn-sm" inf="1">Bloque 1</button>
			<button class="btn lstBtn btn-sm" inf="2">Bloque 2</button>
			<button class="btn lstBtn btn-sm" inf="3">Bloque 3</button>
			<button class="btn lstBtn btn-sm" inf="4">Bloque 4</button>
			<button class="btn lstBtn btn-sm btn-primary curBtn" inf="5">Bloque 5</button>
			<button id="btnAdd" class="btn btn-sm btn-success">Agregar</button>
		</div>
	</body>
</html>